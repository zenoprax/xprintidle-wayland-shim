#!/bin/bash

# Verbose marker file in case it shows up in logs or backups
# Use temporary file to avoid useless write cycles.
export IDLE_MARKER=/tmp/user_is_idle
# 1. Daemon Check: Ensure swayidle is running in the background.
# We use a lock file concept via pgrep to ensure only one instance runs.
if ! pgrep -u "$USER" -x "swayidle" > /dev/null; then
    # Start swayidle detached.
    # -w: Wait for command to finish (needed for proper protocol sync).
    # timeout 5: After 5 second of idle, create/touch the marker file.
    # resume: Immediately remove the marker file when activity is detected.
    nohup swayidle -w \
        timeout 5 'touch "$IDLE_MARKER"' \
        resume 'rm -f "$IDLE_MARKER"' > /dev/null 2>&1 &
fi

# 2. Time Calculation
# If the marker file exists, we are idle. Calculate delta.
if MARK=$(stat -c %Y "$IDLE_MARKER" 2> /dev/null); then
    NOW=$(date +%s)

    # Convert to milliseconds for the Electron app.
    IDLE_SEC=$((NOW - MARK + 5))
    echo $((IDLE_SEC * 1000))
else
    # Stat failed, meaning file does not exist (active)
    echo 0
fi
